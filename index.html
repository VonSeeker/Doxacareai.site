<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DoxaCare AI - Healthcare Assistant for Sierra Leone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f0fdf4;
    }
        
    .typing-indicator::after {
      content: '...';
      animation: typing 1.5s infinite;
    }
        
    @keyframes typing {
      0% { content: '.'; }
      33% { content: '..'; }
      66% { content: '...'; }
    }
        
    .translate-btn {
      transition: all 0.3s ease;
    }
        
    .translate-btn:hover {
      transform: scale(1.05);
    }
        
    .emergency-shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }
        
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
    /* Custom styles for the modal overlay */
    .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
    }
    /* Custom styles for scrollbar in comments section */
    .max-h-48::-webkit-scrollbar {
        width: 8px;
    }
    .max-h-48::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .max-h-48::-webkit-scrollbar-thumb {
        background: #cbd5e1; /* gray-300 */
        border-radius: 10px;
    }
    .max-h-48::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; /* gray-400 */
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div id="auth-root"></div>
  <div id="app-content">
  <!-- Header -->
  <header class="bg-gradient-to-r from-green-600 to-yellow-400 shadow-md">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fas fa-heartbeat text-white text-2xl"></i>
        <h1 class="text-white font-bold text-xl md:text-2xl">DoxaCare AI</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="languageToggle" class="bg-white text-green-800 px-3 py-1 rounded-full text-sm font-medium flex items-center translate-btn">
          <span id="currentLanguage">Krio</span>
          <i class="fas fa-exchange-alt ml-1"></i>
        </button>
        <button id="emergencyBtn" class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center hover:bg-red-700 emergency-shake">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          Emergency
        </button>
        <!-- Account Menu Button -->
        <div class="relative">
            <button id="accountMenuBtn" class="bg-white text-green-800 px-3 py-1 rounded-full text-sm font-medium flex items-center translate-btn">
                <i class="fas fa-user-circle mr-1"></i>
                <span id="accountStatusText">Account</span>
            </button>
            <!-- Account Dropdown/Modal Trigger -->
            <div id="accountDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden">
                <a href="#" id="signInOption" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sign In / Sign Up</a>
                <a href="#" id="signOutOption" class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100 hidden">Sign Out</a>
            </div>
        </div>
      </div>
    </div>
  </header>
  <!-- Nav Tabs -->
  <div class="bg-white shadow-sm">
    <div class="container mx-auto px-4">
      <div class="flex overflow-x-auto">
        <button class="tab-btn active px-4 py-3 text-green-700 font-medium border-b-2 border-green-700 whitespace-nowrap" data-tab="home">
          <i class="fas fa-home mr-2"></i>Home
        </button>
        <button class="tab-btn px-4 py-3 text-gray-600 font-medium whitespace-nowrap" data-tab="symptoms">
          <i class="fas fa-notes-medical mr-2"></i>Health Topics
        </button>
        <button class="tab-btn px-4 py-3 text-gray-600 font-medium whitespace-nowrap" data-tab="advice">
          <i class="fas fa-lightbulb mr-2"></i>Health Advice
        </button>
        <button class="tab-btn px-4 py-3 text-gray-600 font-medium whitespace-nowrap" data-tab="clinics">
          <i class="fas fa-hospital mr-2"></i>Find Clinics
        </button>
          </div>
    </div>
  </div>
  <!-- Main Content -->
  <main class="flex-grow container mx-auto px-4 py-6">
    <!-- Home Tab (default visible) -->
    <div id="home-tab" class="tab-content active">
      <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
        <div class="bg-green-100 p-4 border-b border-green-200">
          <h2 class="text-green-800 font-bold text-lg">Welcome to DoxaCare AI</h2>
          <p id="welcomeText" class="text-gray-700 text-sm mt-1">Your trusted healthcare assistant for Sierra Leone. Ask about symptoms, get health advice, or find nearby clinics.</p>
          <p id="welcomeTextKrio" class="text-gray-700 text-sm mt-1 hidden">DoxaCare AI wey dey for you pan Salone health. Ask about sick wey you get, take health advice, or find clinic close to you.</p>
        </div>
        <div class="p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h3 class="font-bold text-yellow-800 mb-2 flex items-center">
                <i class="fas fa-bell text-yellow-600 mr-2"></i>
                <span id="healthAlertsTitle">Health Alerts</span>
              </h3>
              <div class="text-sm text-gray-700">
                <div id="healthAlertsText">
                  <p>• Monkeypox outbreak spreading nationwide (May 2025)</p>
                  <p>• Avoid contact with wild animals</p>
                  <p>• Isolate if rash/fever develops</p>
                </div>
                <div id="healthAlertsTextKrio" class="hidden">
                  <p>• Monkeypox dey spread for all Salone (May 2025)</p>
                  <p>• No touch bush meat or wild animal</p>
                  <p>• Stay for house if you get rash or fever</p>
                </div>
              </div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <h3 class="font-bold text-blue-800 mb-2 flex items-center">
                <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                <span id="quickLinksTitle">Quick Chats</span>
              </h3>
              <div class="grid grid-cols-2 gap-2">
                <button class="quick-action-btn bg-green-100 text-green-800" data-action="malaria">
                  <i class="fas fa-bug mr-1"></i>
                  <span id="malariaBtnText">Malaria</span>
                </button>
                <button class="quick-action-btn bg-yellow-100 text-yellow-800" data-action="pregnancy">
                  <i class="fas fa-baby mr-1"></i>
                  <span id="pregnancyBtnText">Pregnancy</span>
                </button>
                <button class="quick-action-btn bg-red-100 text-red-800" data-action="diarrhea">
                  <i class="fas fa-tint mr-1"></i>
                  <span id="diarrheaBtnText">Diarrhea</span>
                </button>
                <button class="quick-action-btn bg-purple-100 text-purple-800" data-action="hypertension">
                  <i class="fas fa-heartbeat mr-1"></i>
                  <span id="hypertensionBtnText">Hypertension</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
            <!-- Chat Interface -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-green-600 p-3">
          <h2 class="text-white font-bold flex items-center">
            <i class="fas fa-comments mr-2"></i>
            <span id="chatTitle">Chat with DoxaCare AI</span>
          </h2>
        </div>
        <div id="chatWindow" class="h-64 overflow-y-auto p-4 bg-gray-50">
          <div class="chat-message bot-message mb-3">
            <div class="bg-white p-3 rounded-lg shadow-sm max-w-3/4 inline-block">
              <p id="welcomeChatText">Hello! How can I assist you with your health today? You can describe symptoms, ask for advice, or find clinics near you.</p>
              <p id="welcomeChatTextKrio" class="hidden">How you dey? Wetin I fit do for you health today? You fit talk about sick wey you get, ask for advice, or find clinic close to you.</p>
              <div class="quick-reply-buttons mt-2 flex flex-wrap gap-2">
                <button class="quick-reply-btn bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">I have fever</button>
                <button class="quick-reply-btn bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">Mosquito bite advice</button>
                <button class="quick-reply-btn bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full">Find clinic near me</button>
              </div>
            </div>
          </div>
        </div>
        <div class="p-3 bg-gray-100 border-t border-gray-200">
          <div class="flex items-center">
            <input type="text" id="userInput" placeholder="Type your health question here..." class="flex-grow px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <button id="sendBtn" class="ml-2 bg-green-600 text-white p-2 rounded-full hover:bg-green-700 transition-colors">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
            <!-- Cultural Feature Section -->
      <div class="mt-6 bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-yellow-400 to-green-600 p-3">
          <h2 class="text-white font-bold flex items-center">
            <i class="fas fa-globe-africa mr-2"></i>
            <span id="culturalTitle">Cultural Health Tips</span>
          </h2>
        </div>
        <div class="p-4">
          <div class="flex flex-col md:flex-row items-center">
            <img src="https://images.app.goo.gl/6DwoTn2NgUnF7Di77" alt="Lumley Beach in Freetown, Sierra Leone" class="w-32 h-32 md:w-48 md:h-48 object-cover rounded-lg shadow mb-4 md:mb-0 md:mr-4">
            <div>
              <h3 class="font-semibold text-green-800 mb-2" id="localTipTitle">Local Health Wisdom</h3>
              <div id="culturalTipText" class="text-gray-700">
                <p>• Boil water for drinking to prevent waterborne diseases.</p>
                <p>• Use insecticide-treated nets (ITNs) every night during rainy season.</p>
                <p>• Sun-dry clothes thoroughly to kill germs.</p>
              </div>
              <div id="culturalTipTextKrio" class="text-gray-700 hidden">
                <p>• Make water hot well-well before you drink am to stop water sickness.</p>
                <p>• Use net wey get medicine for kill mosquito every night when rain dey fall.</p>
                <p>• Make sun dry your clothes proper to kill all germ.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
        
    <!-- Symptom Checker Tab -->
    <div id="symptoms-tab" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-blue-600 p-3 flex justify-between items-center">
          <h2 class="text-white font-bold flex items-center">
            <i class="fas fa-notes-medical mr-2"></i>
            <span>Health Topics</span>
          </h2>
          <button id="refreshHealthTopics" class="text-white hover:text-blue-200 transition-colors" title="Refresh health topics">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
        <div class="p-4">
          <div id="symptomInputArea" class="mb-4">
            <label for="symptomsInput" class="block text-gray-700 mb-2">Ask about any health topic:</label>
            <div class="flex">
              <input type="text" id="symptomsInput" class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g. fever, exercise tips, nutrition advice">
              <button id="checkSymptomsBtn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">Ask</button>
            </div>
          </div>
          <div id="symptomResults" class="hidden border-t pt-4">
            <!-- Results will be inserted here by JavaScript -->
          </div>
          <div class="mt-4 p-3 bg-gray-100 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-2">Common Health Topics:</h4>
            <div class="grid grid-cols-2 gap-2">
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Malaria">Malaria</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Typhoid">Typhoid</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Cholera">Cholera</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Dengue">Dengue</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Pneumonia">Pneumonia</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Meningitis">Meningitis</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="Lassa Fever">Lassa Fever</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded text-sm" data-symptoms="COVID-19">COVID-19</button>
            </div>
          </div>
          <div class="mt-4 p-3 bg-gray-100 rounded-lg">
            <h4 class="font-medium text-gray-700 mb-2">Common Symptoms:</h4>
            <div class="flex flex-wrap gap-2">
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Fever</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Exercise</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Nutrition</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Pregnancy</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Diabetes</button>
              <button class="symptom-tag bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded-full text-sm">Mental Health</button>
            </div>
          </div>
        </div>
      </div>
    </div>
        
    <!-- Health Advice Forum Tab -->
    <div id="advice-tab" class="tab-content hidden">
      <div class="max-w-3xl w-full bg-white rounded-lg shadow-md overflow-hidden">
          <div class="bg-purple-600 p-3 flex justify-between items-center rounded-t-lg">
              <h2 class="text-white font-bold flex items-center text-xl">
                  <i class="fas fa-comments mr-2"></i>
                  Community Health Forum
              </h2>
              <button id="newPostBtn"
                  class="bg-white text-purple-600 px-3 py-1 rounded-full text-sm font-medium hover:bg-purple-100 transition-colors shadow-sm">
                  <i class="fas fa-plus mr-1"></i> New Post
              </button>
          </div>

          <div id="postsContainer" class="p-4 space-y-4">
              <!-- Posts will be dynamically inserted here by JavaScript -->
              <div id="noPostsMessage" class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center text-gray-600">
                  <i class="fas fa-exclamation-circle text-gray-400 text-3xl mb-3"></i>
                  <p class="font-medium text-lg mb-2">No posts yet!</p>
                  <p class="mb-4">Be the first to share a health question or advice with the community.</p>
                  <button id="startNewDiscussionBtn"
                      class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-md">
                      Start a New Discussion
                  </button>
              </div>
          </div>

          <!-- New Post Modal -->
          <div id="newPostModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
              <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="newPostModalContent">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-purple-700">Create New Post</h3>
                      <button id="closeNewPostModalBtn" class="text-gray-500 hover:text-gray-700">
                          <i class="fas fa-times text-lg"></i>
                      </button>
                  </div>
                  <div class="mb-4">
                      <label for="postTitle" class="block text-gray-700 text-sm font-medium mb-2">
                          Title:
                      </label>
                      <input type="text" id="postTitle"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="Enter post title">
                  </div>
                  <div class="mb-4">
                      <label for="postCity" class="block text-gray-700 text-sm font-medium mb-2">
                          City/Town:
                      </label>
                      <input type="text" id="postCity"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                          placeholder="e.g., Freetown, Bo">
                  </div>
                  <div class="mb-6">
                      <label for="postContent" class="block text-gray-700 text-sm font-medium mb-2">
                          Content:
                      </label>
                      <textarea id="postContent" rows="5"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-y"
                          placeholder="Share your health question or advice..."></textarea>
                  </div>
                  <div class="flex justify-end space-x-3">
                      <button id="cancelPostBtn"
                          class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors shadow-sm">
                          Cancel
                      </button>
                      <button id="submitPostBtn"
                          class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-md">
                          Submit Post
                      </button>
                  </div>
              </div>
          </div>

          <!-- Custom Alert Modal -->
          <div id="customAlertModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
              <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="customAlertModalContent">
                  <div class="flex justify-between items-center mb-4">
                      <h3 class="text-xl font-bold text-red-700" id="alertTitle">Alert</h3>
                      <button id="closeAlertModalBtn" class="text-gray-500 hover:text-gray-700">
                          <i class="fas fa-times text-lg"></i>
                      </button>
                  </div>
                  <p id="alertMessage" class="text-gray-700 mb-6"></p>
                  <div class="flex justify-end">
                      <button id="okAlertBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors shadow-md">
                          OK
                      </button>
                  </div>
              </div>
          </div>
      </div>
    </div>
        
    <!-- Find Clinics Tab -->
    <div id="clinics-tab" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-red-600 p-3">
          <h2 class="text-white font-bold flex items-center">
            <i class="fas fa-hospital mr-2"></i>
            <span>Find Clinics</span>
          </h2>
        </div>
        <div class="p-4">
          <div class="mb-4">
            <label for="locationInput" class="block text-gray-700 mb-2">Enter your location (district or city):</label>
            <div class="flex">
              <input type="text" id="locationInput" class="flex-grow px-4 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="e.g. Freetown, Bo, Kenema">
              <button id="findClinicsBtn" class="bg-red-600 text-white px-4 py-2 rounded-r-lg hover:bg-red-700">Search</button>
            </div>
          </div>
          <div id="clinicResults" class="space-y-4">
            <!-- Clinic cards will be dynamically inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>
        </main>
  <!-- Footer -->
  <footer class="bg-green-800 text-white py-6">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <h3 class="font-bold mb-3">DoxaCare AI</h3>
          <p class="text-sm">Providing trusted healthcare advice for Sierra Leone</p>
          <div class="mt-3">
            <p class="text-sm"><i class="fas fa-phone-alt mr-2"></i> Emergency: 117, 112</p>
          </div>
        </div>
        <div>
          <h3 class="font-bold mb-3">Important Links</h3>
          <ul class="space-y-2 text-sm">
            <li><a href="https://www.who.int/countries/sle" target="_blank" class="hover:underline">WHO Sierra Leone</a></li>
            <li><a href="https://mohs.gov.sl" target="_blank" class="hover:underline">Sierra Leone Ministry of Health</a></li>
            <li><a href="https://www.nmcp.gov.sl" target="_blank" class="hover:underline">National Malaria Control Program</a></li>
            <li><a href="https://www.unicef.org/sierraleone/health" target="_blank" class="hover:underline">UNICEF Child Health</a></li>
          </ul>
        </div>
        <div>
          <h3 class="font-bold mb-3">Disclaimer</h3>
          <p class="text-xs">DoxaCare AI provides general health information only and does not replace professional medical advice. Always consult a qualified healthcare provider for diagnosis and treatment.</p>
        </div>
      </div>
      <div class="border-t border-green-700 mt-6 pt-4 text-center text-sm">
        <p>© 2023 DoxaCare AI - Healthcare Assistant for Sierra Leone</p>
      </div>
    </div>
  </footer>
  <!-- Emergency Modal -->
  <div id="emergencyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-red-600">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          Emergency Assistance
        </h3>
        <button id="closeEmergencyModal" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p class="text-gray-700 mb-4">If you're experiencing a medical emergency, please take these immediate actions:</p>
      <ul class="space-y-2 mb-4">
        <li class="flex items-start">
          <i class="fas fa-phone-alt text-red-500 mt-1 mr-2"></i>
          <span>Call emergency services: <strong>117 or 112</strong></span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-hospital text-red-500 mt-1 mr-2"></i>
          <span>Go to the nearest hospital immediately</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-user-md text-red-500 mt-1 mr-2"></i>
          <span>Alert someone nearby for assistance</span>
        </li>
      </ul>
      <div class="bg-red-50 border border-red-200 rounded p-3 mb-4">
        <p class="text-sm text-red-700">Call 117 or go to the closest medical facility immediately if you experience:</p>
        <ul class="list-disc list-inside text-sm text-red-700 mt-1 pl-2">
          <li>Difficulty breathing</li>
          <li>Chest pain</li>
          <li>Severe bleeding</li>
          <li>Loss of consciousness</li>
        </ul>
      </div>
      <button id="callEmergencyBtn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
        <i class="fas fa-phone mr-2"></i> Call Emergency Services Now
      </button>
    </div>
  </div>

  <!-- Account Modal -->
  <div id="accountModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
      <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 transform transition-all duration-300 scale-95 opacity-0" id="accountModalContent">
          <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-bold text-green-700" id="accountModalTitle">Sign In / Sign Up</h3>
              <button id="closeAccountModalBtn" class="text-gray-500 hover:text-gray-700">
                  <i class="fas fa-times text-lg"></i>
              </button>
          </div>

          <!-- Removed Social Login Options -->
          <!--
          <div class="space-y-3 mb-6">
              <button id="googleSignInBtn" class="w-full bg-red-500 text-white py-2 px-4 rounded-lg flex items-center justify-center hover:bg-red-600 transition-colors shadow-md">
                  <i class="fab fa-google mr-2"></i> Sign in with Google
              </button>
              <button id="facebookSignInBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center justify-center hover:bg-blue-700 transition-colors shadow-md">
                  <i class="fab fa-facebook-f mr-2"></i> Sign in with Facebook
              </button>
          </div>
          <div class="relative flex py-5 items-center">
              <div class="flex-grow border-t border-gray-300"></div>
              <span class="flex-shrink mx-4 text-gray-500">Or</span>
              <div class="flex-grow border-t border-gray-300"></div>
          </div>
          -->

          <!-- Sign Up Form -->
          <form id="signUpForm" class="space-y-4">
              <div>
                  <label for="firstName" class="block text-gray-700 text-sm font-medium mb-1">First Name:</label>
                  <input type="text" id="firstName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Your first name">
              </div>
              <div>
                  <label for="lastName" class="block text-gray-700 text-sm font-medium mb-1">Last Name:</label>
                  <input type="text" id="lastName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Your last name">
              </div>
              <div>
                  <label for="phone" class="block text-gray-700 text-sm font-medium mb-1">Phone Number:</label>
                  <input type="tel" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="e.g., +23276123456">
              </div>
              <div>
                  <label for="username" class="block text-gray-700 text-sm font-medium mb-1">Username:</label>
                  <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Choose a username">
              </div>
              <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                  Sign Up
              </button>
          </form>
          <p id="authMessage" class="mt-4 text-center text-sm text-red-600"></p>
      </div>
  </div>

  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, FacebookAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Initialize Firebase
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables for Firebase instances and user ID
    let currentUserId = null;
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Define appId globally

    // Helper function for custom alert
    function showAlert(message, title = 'Alert') {
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertModalContent = document.getElementById('customAlertModalContent');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');

        alertTitle.textContent = title;
        alertMessage.textContent = message;
        customAlertModal.classList.remove('hidden');
        setTimeout(() => {
            customAlertModalContent.classList.remove('opacity-0', 'scale-95');
            customAlertModalContent.classList.add('opacity-100', 'scale-100');
        }, 10); // Small delay for transition
    }

    function hideAlert() {
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertModalContent = document.getElementById('customAlertModalContent');

        customAlertModalContent.classList.remove('opacity-100', 'scale-100');
        customAlertModalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            customAlertModal.classList.add('hidden');
        }, 300); // Match transition duration
    }

    // Function to hide the account modal
    function hideAccountModal() {
        const accountModal = document.getElementById('accountModal');
        const accountModalContent = document.getElementById('accountModalContent');

        accountModalContent.classList.remove('opacity-100', 'scale-100');
        accountModalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            accountModal.classList.add('hidden');
        }, 300);
    }

    // Function to hide the new post modal
    function hideNewPostModal() {
        const newPostModal = document.getElementById('newPostModal');
        const newPostModalContent = document.getElementById('newPostModalContent');
        newPostModalContent.classList.remove('opacity-100', 'scale-100');
        newPostModalContent.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            newPostModal.classList.add('hidden');
        }, 300); // Match transition duration
    }

    // Function to get or create user profile in Firestore
    async function getUserProfile(uid, email, displayName, photoURL) {
        const userProfileRef = doc(db, `artifacts/${appId}/users/${uid}/user_profiles`, "profile");
        const docSnap = await getDoc(userProfileRef);

        if (!docSnap.exists()) {
            // Create a new profile if it doesn't exist
            const newProfile = {
                uid: uid,
                email: email || null,
                displayName: displayName || null,
                photoURL: photoURL || null,
                firstName: null,
                lastName: null,
                phone: null,
                username: null,
                createdAt: new Date().toISOString()
            };
            await setDoc(userProfileRef, newProfile);
            return newProfile;
        } else {
            return docSnap.data();
        }
    }

    // Function to update user profile in Firestore (for sign-up form)
    async function updateUserProfile(uid, firstName, lastName, phone, username) {
        const userProfileRef = doc(db, `artifacts/${appId}/users/${uid}/user_profiles`, "profile");
        await setDoc(userProfileRef, {
            firstName: firstName,
            lastName: lastName,
            phone: phone,
            username: username,
            updatedAt: new Date().toISOString()
        }, { merge: true }); // Merge to update existing fields without overwriting others
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            console.log("User is signed in:", user.uid);
            const userProfile = await getUserProfile(user.uid, user.email, user.displayName, user.photoURL);
            updateAccountStatusUI(userProfile);
        } else {
            currentUserId = null;
            console.log("User is signed out.");
            updateAccountStatusUI(null);
            // Sign in anonymously if no user is signed in and no initial token is provided
            if (typeof __initial_auth_token === 'undefined') {
                 try {
                     await signInAnonymously(auth);
                     console.log("Signed in anonymously.");
                 } catch (error) {
                     console.error("Error signing in anonymously:", error);
                 }
            }
        }
        isAuthReady = true; // Firebase Auth is ready
    });

    // Initial sign-in with custom token if available, otherwise anonymously
    async function initializeAuth() {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await signInWithCustomToken(auth, __initial_auth_token);
                console.log("Signed in with custom token.");
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                // Fallback to anonymous if custom token fails
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously after custom token failure.");
                } catch (anonError) {
                    console.error("Error signing in anonymously:", anonError);
                }
            }
        } else {
            try {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            } catch (error) {
                console.error("Error signing in anonymously:", error);
            }
        }
    }

    // Call initializeAuth on script load
    initializeAuth();

    // DOM Elements for Account Menu
    const accountMenuBtn = document.getElementById('accountMenuBtn');
    const accountDropdown = document.getElementById('accountDropdown');
    const accountStatusText = document.getElementById('accountStatusText');
    const signInOption = document.getElementById('signInOption');
    const signOutOption = document.getElementById('signOutOption');

    // DOM Elements for Account Modal
    const accountModal = document.getElementById('accountModal');
    const accountModalContent = document.getElementById('accountModalContent');
    const closeAccountModalBtn = document.getElementById('closeAccountModalBtn');
    // Removed social login buttons: const googleSignInBtn = document.getElementById('googleSignInBtn');
    // Removed social login buttons: const facebookSignInBtn = document.getElementById('facebookSignInBtn');
    const signUpForm = document.getElementById('signUpForm');
    const firstNameInput = document.getElementById('firstName');
    const lastNameInput = document.getElementById('lastName');
    const phoneInput = document.getElementById('phone');
    const usernameInput = document.getElementById('username');
    const authMessage = document.getElementById('authMessage');

    // Toggle Account Dropdown
    accountMenuBtn?.addEventListener('click', () => {
        accountDropdown.classList.toggle('hidden');
    });

    // Close dropdown if clicked outside
    document.addEventListener('click', (event) => {
        if (!accountMenuBtn.contains(event.target) && !accountDropdown.contains(event.target)) {
            accountDropdown.classList.add('hidden');
        }
    });

    // Show Account Modal
    signInOption?.addEventListener('click', (e) => {
        e.preventDefault();
        accountDropdown.classList.add('hidden'); // Hide dropdown
        accountModal.classList.remove('hidden');
        setTimeout(() => {
            accountModalContent.classList.remove('opacity-0', 'scale-95');
            accountModalContent.classList.add('opacity-100', 'scale-100');
        }, 10);
        authMessage.textContent = ''; // Clear previous messages
    });

    // Hide Account Modal
    closeAccountModalBtn?.addEventListener('click', () => {
        hideAccountModal();
    });

    // Close modal if clicking outside the content
    accountModal.addEventListener('click', (event) => {
        if (event.target === accountModal) {
            hideAccountModal();
        }
    });

    // Update UI based on auth state
    function updateAccountStatusUI(userProfile) {
        if (userProfile && userProfile.username) {
            accountStatusText.textContent = userProfile.username;
            signInOption.classList.add('hidden');
            signOutOption.classList.remove('hidden');
        } else if (userProfile && userProfile.displayName) {
            accountStatusText.textContent = userProfile.displayName.split(' ')[0]; // Show first name
            signInOption.classList.add('hidden');
            signOutOption.classList.remove('hidden');
        } else if (auth.currentUser && auth.currentUser.isAnonymous) {
            accountStatusText.textContent = 'Guest';
            signInOption.classList.remove('hidden');
            signOutOption.classList.add('hidden'); // Guests can't "sign out" in the traditional sense, they can only sign in
        } else {
            accountStatusText.textContent = 'Account';
            signInOption.classList.remove('hidden');
            signOutOption.classList.add('hidden');
        }
        hideAccountModal(); // Always hide modal after auth state change
    }

    // Removed Google Sign-in event listener
    // googleSignInBtn?.addEventListener('click', async () => { ... });

    // Removed Facebook Sign-in event listener
    // facebookSignInBtn?.addEventListener('click', async () => { ... });

    // Sign Up (Update Profile for Anonymous User)
    signUpForm?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        const phone = phoneInput.value.trim();
        const username = usernameInput.value.trim();

        if (!firstName || !lastName || !phone || !username) {
            authMessage.textContent = 'Please fill in all fields.';
            authMessage.className = 'mt-4 text-center text-sm text-red-600';
            return;
        }

        if (!currentUserId) {
            authMessage.textContent = 'Authentication not ready. Please try again.';
            authMessage.className = 'mt-4 text-center text-sm text-red-600';
            return;
        }

        try {
            await updateUserProfile(currentUserId, firstName, lastName, phone, username);
            authMessage.textContent = 'Profile updated successfully!';
            authMessage.className = 'mt-4 text-center text-sm text-green-600';
            // Update UI after successful profile update
            updateAccountStatusUI({ username: username }); // Pass the new username to update UI
            // Clear form fields
            firstNameInput.value = '';
            lastNameInput.value = '';
            phoneInput.value = '';
            usernameInput.value = '';
            hideAccountModal();
        } catch (error) {
            console.error("Sign Up (Profile Update) Error:", error);
            authMessage.textContent = `Sign up failed: ${error.message}`;
            authMessage.className = 'mt-4 text-center text-sm text-red-600';
        }
    });

    // Sign Out
    signOutOption?.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await signOut(auth);
            console.log("User signed out.");
            // onAuthStateChanged listener will handle UI update
        } catch (error) {
            console.error("Sign Out Error:", error);
            showAlert(`Failed to sign out: ${error.message}`, 'Sign Out Error');
        }
    });


    // Force refresh by adding cache-busting parameter
    if (performance.navigation.type === 1) {
      window.location.search = '?refresh=' + new Date().getTime();
    }
        // Language Toggle
    const languageToggle = document.getElementById('languageToggle');
    const currentLanguage = document.getElementById('currentLanguage');
    const welcomeText = document.getElementById('welcomeText');
    const welcomeTextKrio = document.getElementById('welcomeTextKrio');
    const welcomeChatText = document.getElementById('welcomeChatText');
    const welcomeChatTextKrio = document.getElementById('welcomeChatTextKrio');
    const healthAlertsText = document.getElementById('healthAlertsText');
    const healthAlertsTextKrio = document.getElementById('healthAlertsTextKrio');
    const culturalTipText = document.getElementById('culturalTipText');
    const culturalTipTextKrio = document.getElementById('culturalTipTextKrio');
    const malariaBtnText = document.getElementById('malariaBtnText');
    const pregnancyBtnText = document.getElementById('pregnancyBtnText');
    const diarrheaBtnText = document.getElementById('diarrheaBtnText');
    const hypertensionBtnText = document.getElementById('hypertensionBtnText');
    const chatTitle = document.getElementById('chatTitle');
    const welcomeTitle = document.getElementById('welcomeTitle');
    const culturalTitle = document.getElementById('culturalTitle');
    const localTipTitle = document.getElementById('localTipTitle');
    const healthAlertsTitle = document.getElementById('healthAlertsTitle');
    const quickLinksTitle = document.getElementById('quickLinksTitle');
        let isEnglish = false;
        languageToggle.addEventListener('click', () => {
      isEnglish = !isEnglish;
            if (isEnglish) {
        currentLanguage.textContent = 'English';
        welcomeText.classList.remove('hidden');
        welcomeTextKrio.classList.add('hidden');
        healthAlertsText.classList.remove('hidden');
        healthAlertsTextKrio.classList.add('hidden');
        welcomeChatText.classList.remove('hidden');
        welcomeChatTextKrio.classList.add('hidden');
        culturalTipText.classList.remove('hidden');
        culturalTipTextKrio.classList.add('hidden');
        malariaBtnText.textContent = 'Malaria';
        pregnancyBtnText.textContent = 'Pregnancy';
        diarrheaBtnText.textContent = 'Diarrhea';
        hypertensionBtnText.textContent = 'Hypertension';
        chatTitle.textContent = 'Chat with DoxaCare AI';
        culturalTitle.textContent = 'Cultural Health Tips';
        localTipTitle.textContent = 'Local Health Wisdom';
        healthAlertsTitle.textContent = 'Health Alerts';
        quickLinksTitle.textContent = 'Quick Chats';
      } else {
        currentLanguage.textContent = 'Krio';
        welcomeText.classList.add('hidden');
        welcomeTextKrio.classList.remove('hidden');
        healthAlertsText.classList.add('hidden');
        healthAlertsTextKrio.classList.remove('hidden');
        welcomeChatText.classList.add('hidden');
        welcomeChatTextKrio.classList.remove('hidden');
        culturalTipText.classList.add('hidden');
        culturalTipTextKrio.classList.remove('hidden');
        malariaBtnText.textContent = 'Malaria';
        pregnancyBtnText.textContent = 'Belleful';
        diarrheaBtnText.textContent = 'Run belle';
        hypertensionBtnText.textContent = 'High BP';
        chatTitle.textContent = 'Chat wit DoxaCare AI';
        culturalTitle.textContent = 'Health Tip for We Culture';
        localTipTitle.textContent = 'Local Health Sense';
        healthAlertsTitle.textContent = 'Health News';
        quickLinksTitle.textContent = 'Quick Chat';
      }
    });
        // Tab Switching
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
        tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
                // Update active state for buttons
        tabButtons.forEach(btn => btn.classList.remove('active', 'text-green-700', 'border-green-700'));
        button.classList.add('active', 'text-green-700', 'border-green-700');
                // Update active state for tab contents
        tabContents.forEach(content => {
          content.classList.add('hidden');
          content.classList.remove('active');
        });
                document.getElementById(`${tabId}-tab`).classList.remove('hidden');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });
        // Quick Action Buttons
    const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        quickActionBtns.forEach(button => {
      button.addEventListener('click', () => {
        const action = button.getAttribute('data-action');
        const chatWindow = document.getElementById('chatWindow');
                switch(action) {
          case 'malaria':
            addUserMessage('malaria prevention');
            simulateBotResponse('Malaria prevention is crucial in Sierra Leone. Use insecticide-treated mosquito nets every night, wear protective clothing in the evening, and eliminate stagnant water around your home where mosquitoes breed. If you experience fever, headache, or chills, seek medical attention immediately as these could be malaria symptoms.');
            break;
          case 'pregnancy':
            addUserMessage('pregnancy care');
            simulateBotResponse('For healthy pregnancy: Attend all antenatal check-ups, take prescribed iron and folic acid supplements, eat nutritious meals, and learn about danger signs like severe headaches, blurred vision,');
            break;
          case 'diarrhea':
            addUserMessage('diarrhea treatment');
            simulateBotResponse('For diarrhea, the most important thing is to prevent dehydration. Drink plenty of fluids, especially Oral Rehydration Salts (ORS). Avoid sugary drinks. If diarrhea is severe, bloody, or accompanied by high fever, seek medical attention.');
            break;
          case 'hypertension':
            addUserMessage('hypertension management');
            simulateBotResponse('Hypertension (high blood pressure) can be managed with a healthy diet low in salt, regular exercise, maintaining a healthy weight, and avoiding smoking and excessive alcohol. Regular check-ups and medication as prescribed by a doctor are essential.');
            break;
          default:
            simulateBotResponse("I'm not sure about that specific quick action, but I can help with general health questions!");
        }
      });
    });

    // Chatbot functionality (simplified)
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatWindow = document.getElementById('chatWindow');

    function addUserMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message', 'user-message', 'mb-3', 'text-right');
      messageDiv.innerHTML = `<div class="bg-green-500 p-3 rounded-lg shadow-sm max-w-3/4 inline-block text-white">${message}</div>`;
      chatWindow.appendChild(messageDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
    }

    // Function to format bot responses from plain text/markdown to HTML
    function formatBotResponse(text) {
      // Replace double newlines with paragraph breaks, adding mb-2 for spacing
      let formattedText = text.replace(/\n\n/g, '</p><p class="mb-2">');
      // Replace single newlines with line breaks
      formattedText = formattedText.replace(/\n/g, '<br>');
      // Basic bolding: **text** to <strong>text</strong>
      formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      // Basic italics: *text* to <em>text</em>
      formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
      // Wrap in a paragraph if not already starting with one, adding mb-2
      if (!formattedText.startsWith('<p')) {
          formattedText = `<p class="mb-2">${formattedText}</p>`;
      }
      return formattedText;
    }


    async function simulateBotResponse(userMessage) {
      const typingIndicator = document.createElement('div');
      typingIndicator.classList.add('chat-message', 'bot-message', 'mb-3', 'typing-indicator');
      typingIndicator.innerHTML = '<div class="bg-white p-3 rounded-lg shadow-sm max-w-3/4 inline-block italic text-gray-500 leading-relaxed">DoxaCare AI is thinking...</div>';
      chatWindow.appendChild(typingIndicator);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
          let chatHistory = [];
          chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
          const payload = { contents: chatHistory };
          const apiKey = ""; // Canvas will automatically provide the API key
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          const result = await response.json();
          let botResponseText = "I'm sorry, I couldn't get a response at this time. Please try again.";

          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
              botResponseText = result.candidates[0].content.parts[0].text;
          } else {
              console.error("Unexpected API response structure:", result);
          }

          chatWindow.removeChild(typingIndicator);
          const botMessageDiv = document.createElement('div');
          botMessageDiv.classList.add('chat-message', 'bot-message', 'mb-3');
          // Apply formatting here, and add leading-relaxed to the container
          const formattedHtmlResponse = formatBotResponse(botResponseText);
          botMessageDiv.innerHTML = `<div class="bg-white p-3 rounded-lg shadow-sm max-w-3/4 inline-block leading-relaxed">${formattedHtmlResponse}</div>`;
          chatWindow.appendChild(botMessageDiv);
          chatWindow.scrollTop = chatWindow.scrollHeight;

      } catch (error) {
          console.error("Error communicating with Gemini API:", error);
          chatWindow.removeChild(typingIndicator);
          const errorMessageDiv = document.createElement('div');
          errorMessageDiv.classList.add('chat-message', 'bot-message', 'mb-3');
          errorMessageDiv.innerHTML = `<div class="bg-red-100 text-red-700 p-3 rounded-lg shadow-sm max-w-3/4 inline-block leading-relaxed">Error: Could not get a response. Please check your internet connection or try again later.</div>`;
          chatWindow.appendChild(errorMessageDiv);
          chatWindow.scrollTop = chatWindow.scrollHeight;
      }
    }

    sendBtn?.addEventListener('click', () => {
      const message = userInput.value.trim();
      if (message) {
        addUserMessage(message);
        simulateBotResponse(message);
        userInput.value = '';
      }
    });

    userInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendBtn?.click();
      }
    });

    document.querySelectorAll('.quick-reply-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const text = event.target.textContent || '';
        if (text) {
          addUserMessage(text);
          simulateBotResponse(text);
        }
      });
    });

    // Symptom checker functionality (now uses Gemini API)
    const symptomsInput = document.getElementById('symptomsInput');
    const checkSymptomsBtn = document.getElementById('checkSymptomsBtn');
    const symptomResults = document.getElementById('symptomResults');
    const refreshHealthTopics = document.getElementById('refreshHealthTopics');

    async function simulateHealthTopicResponse(topic) {
      symptomResults.innerHTML = ''; // Clear previous results
      symptomResults.classList.remove('hidden'); // Ensure results section is visible

      const typingIndicator = document.createElement('div');
      typingIndicator.classList.add('bg-gray-100', 'p-3', 'rounded-lg', 'shadow-sm', 'text-center', 'text-gray-500', 'italic', 'typing-indicator', 'leading-relaxed');
      typingIndicator.textContent = 'DoxaCare AI is fetching information...';
      symptomResults.appendChild(typingIndicator);

      try {
          let chatHistory = [];
          // Craft a more specific prompt for health topics
          const prompt = `Provide detailed and accurate health information about "${topic}" relevant to Sierra Leone, including symptoms, prevention, and common treatments. Format the response clearly with paragraphs and important terms in bold.`;
          chatHistory.push({ role: "user", parts: [{ text: prompt }] });
          const payload = { contents: chatHistory };
          const apiKey = ""; // Canvas will automatically provide the API key
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          const result = await response.json();
          let botResponseText = "<p class='text-gray-600 italic'>I'm sorry, I couldn't get detailed information for that topic at this time. Please try again or ask a different question.</p>";

          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
              botResponseText = formatBotResponse(result.candidates[0].content.parts[0].text);
          } else {
              console.error("Unexpected API response structure for health topics:", result);
          }
          
          symptomResults.removeChild(typingIndicator); // Remove loading indicator
          symptomResults.innerHTML = `
            <h3 class="font-semibold text-blue-800 mb-3">Information on ${topic}:</h3>
            <div class="text-gray-700 leading-relaxed">${botResponseText}</div>
          `;

      } catch (error) {
          console.error("Error communicating with Gemini API for health topics:", error);
          symptomResults.removeChild(typingIndicator); // Remove loading indicator
          symptomResults.innerHTML = `<p class="text-red-700 leading-relaxed">Error: Could not fetch information for "${topic}". Please check your internet connection or try again later.</p>`;
      }
    }

    checkSymptomsBtn?.addEventListener('click', () => {
      const inputTopic = symptomsInput.value.trim();
      if (inputTopic) {
        simulateHealthTopicResponse(inputTopic);
      } else {
        showAlert("Please enter a health topic or symptom.");
      }
    });

    symptomsInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkSymptomsBtn?.click();
      }
    });

    document.querySelectorAll('.symptom-tag').forEach(button => {
      button.addEventListener('click', (event) => {
        const tagText = event.target.textContent || '';
        const dataSymptoms = event.target.dataset.symptoms || tagText;
        symptomsInput.value = dataSymptoms; // Prefill input with the tag value
        simulateHealthTopicResponse(dataSymptoms); // Directly call API with the tag
      });
    });

    refreshHealthTopics?.addEventListener('click', () => {
      symptomsInput.value = '';
      if (symptomResults) {
        symptomResults.innerHTML = '';
        symptomResults.classList.add('hidden');
      }
    });

    // Find Clinics functionality (expanded)
    const sierraLeoneClinics = {
      "freetown": [
        { name: "Connaught Hospital", type: "Government Hospital", address: "Lightfoot Boston St, Freetown", phone: "+232 25 345678", services: "General medicine, emergency, surgery. Open 24/7." },
        { name: "Lumley Community Clinic", type: "Community Health Centre", address: "Lumley Beach Rd, Freetown", phone: "+232 78 123456", services: "Outpatient care, maternal & child health. Mon-Fri, 8 AM - 5 PM." },
        { name: "Choithram Memorial Hospital", type: "Private Hospital", address: "Hill Station, Freetown", phone: "+232 79 987654", services: "Specialized care, diagnostics, surgery." },
        { name: "PCMH (Princess Christian Maternity Hospital)", type: "Maternity Hospital", address: "Freetown Central", phone: "+232 76 112233", services: "Maternal and child health services." }
      ],
      "bo": [
        { name: "Bo Government Hospital", type: "Government Hospital", address: "Hospital Road, Bo", phone: "+232 76 345678", services: "General hospital services. Open 24/7." },
        { name: "Bo Clinic Centre", type: "Private Clinic", address: "Dambala Road, Bo", phone: "+232 77 876543", services: "General consultations, minor procedures." }
      ],
      "kenema": [
        { name: "Kenema Government Hospital", type: "Government Hospital", address: "Clinic Road, Kenema", phone: "+232 76 987654", services: "Major regional hospital. Open 24/7." },
        { name: "Kenema Health Post", type: "Community Health Post", address: "Ngelehun, Kenema", phone: "N/A", services: "Basic health services, vaccinations." }
      ],
      "makeni": [
        { name: "Makeni Government Hospital", type: "Government Hospital", address: "Hospital Road, Makeni", phone: "+232 76 223344", services: "General hospital services." },
        { name: "St. John of God Hospital (Fatima Hospital)", type: "Mission Hospital", address: "Makeni", phone: "+232 77 556677", services: "General medical, surgical, and maternity services." }
      ],
      "port loko": [
        { name: "Port Loko Government Hospital", type: "Government Hospital", address: "Hospital Road, Port Loko", phone: "+232 76 889900", services: "General hospital services." }
      ],
      "kailahun": [
        { name: "Kailahun Government Hospital", type: "Government Hospital", address: "Hospital Road, Kailahun", phone: "+232 76 112233", services: "General hospital services." },
        { name: "Daru Community Health Centre", type: "Community Health Centre", address: "Daru, Kailahun", phone: "N/A", services: "Basic health services." }
      ],
      "kono": [
        { name: "Kono Government Hospital (Koidu)", type: "Government Hospital", address: "Koidu Town, Kono", phone: "+232 76 445566", services: "General hospital services." }
      ],
      "moyamba": [
        { name: "Moyamba Government Hospital", type: "Government Hospital", address: "Hospital Road, Moyamba", phone: "+232 76 778899", services: "General hospital services." }
      ],
      "bombali": [
        { name: "Bombali District Hospital", type: "Government Hospital", address: "Makeni", phone: "+232 76 223344", services: "General hospital services (same as Makeni Gov. Hospital for this example)." }
      ],
      "tonkolili": [
        { name: "Magburaka Government Hospital", type: "Government Hospital", address: "Magburaka, Tonkolili", phone: "+232 76 334455", services: "General hospital services." }
      ],
      "pujehun": [
        { name: "Pujehun Government Hospital", type: "Government Hospital", address: "Pujehun", phone: "+232 76 990011", services: "General hospital services." }
      ],
      "kambia": [
        { name: "Kambia Government Hospital", type: "Government Hospital", address: "Kambia", phone: "+232 76 102030", services: "General hospital services." }
      ],
      "bonthe": [
        { name: "Bonthe Government Hospital", type: "Government Hospital", address: "Bonthe Island", phone: "+232 76 405060", services: "General hospital services." }
      ],
      "koinadugu": [
        { name: "Kabala Government Hospital", type: "Government Hospital", address: "Kabala, Koinadugu", phone: "+232 76 708090", services: "General hospital services." }
      ],
      "falaba": [
        { name: "Falaba District Hospital", type: "Government Hospital", address: "Bendugu, Falaba", phone: "N/A", services: "General hospital services (newest district)." }
      ],
      " karene": [
        { name: "Karene District Hospital", type: "Government Hospital", address: "Karene", phone: "N/A", services: "General hospital services (newest district)." }
      ]
    };

    function simulateClinicSearch(location) {
      let resultsHTML = '';
      const lowerLocation = location.toLowerCase();
      const clinicsInDistrict = sierraLeoneClinics[lowerLocation];

      if (clinicsInDistrict && clinicsInDistrict.length > 0) {
        clinicsInDistrict.forEach(clinic => {
          resultsHTML += `
            <div class="border border-gray-200 rounded-lg p-3 shadow-sm">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="font-semibold text-red-700">${clinic.name}</h3>
                  <p class="text-sm text-gray-600">${clinic.address} • ${clinic.type}</p>
                </div>
                ${clinic.services.includes('24/7') ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">24-Hour</span>' : ''}
              </div>
              ${clinic.phone !== 'N/A' ? `
              <div class="mt-2 flex items-center text-sm">
                <i class="fas fa-phone-alt text-blue-500 mr-2"></i>
                <span>${clinic.phone}</span>
              </div>` : ''}
              <div class="mt-1 flex items-center text-sm">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                <span>Services: ${clinic.services}</span>
              </div>
              <a href="#" class="text-red-500 hover:underline text-sm mt-2 block">View on Map</a>
            </div>
          `;
        });
      } else {
        resultsHTML = `<p class="text-gray-600 italic">No clinics found for "${location}". Please try a different district or city in Sierra Leone. (e.g., Freetown, Bo, Kenema, Makeni, Port Loko, Kailahun, Kono, Moyamba, Bombali, Tonkolili, Pujehun, Kambia, Bonthe, Koinadugu, Falaba, Karene)</p>`;
      }

      if (clinicResults) {
        clinicResults.innerHTML = resultsHTML;
      }
    }

    findClinicsBtn?.addEventListener('click', () => {
      const location = locationInput.value.trim();
      if (location) {
        simulateClinicSearch(location);
      } else {
        showAlert("Please enter a location to search for clinics.");
      }
    });

    locationInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        findClinicsBtn?.click();
      }
    });

    // START Community Forum JS
    // Global state variables
    let posts = [];

    // DOM elements
    // Note: These elements are within the #advice-tab, so ensure they are correctly scoped if other tabs use similar IDs.
    // For this combined file, we'll assume unique IDs across the entire document.
    const postsContainer = document.getElementById('postsContainer');
    const noPostsMessage = document.getElementById('noPostsMessage');
    const newPostBtn = document.getElementById('newPostBtn');
    const startNewDiscussionBtn = document.getElementById('startNewDiscussionBtn');
    const newPostModal = document.getElementById('newPostModal');
    const newPostModalContent = document.getElementById('newPostModalContent');
    const closeNewPostModalBtn = document.getElementById('closeNewPostModalBtn');
    const postTitleInput = document.getElementById('postTitle');
    const postCityInput = document.getElementById('postCity'); // Corrected: removed "= document"
    const postContentTextarea = document.getElementById('postContent');
    const cancelPostBtn = document.getElementById('cancelPostBtn');
    const submitPostBtn = document.getElementById('submitPostBtn');

    // Event listeners for custom alert
    const closeAlertModalBtn = document.getElementById('closeAlertModalBtn');
    const okAlertBtn = document.getElementById('okAlertBtn');
    closeAlertModalBtn.addEventListener('click', hideAlert);
    okAlertBtn.addEventListener('click', hideAlert);


    // Helper function to generate unique IDs
    function generateUniqueId() {
        return Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
    }

    // Helper function to format timestamp
    function formatTimestamp(date) {
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
        };
        return new Intl.DateTimeFormat('en-US', options).format(date);
    }

    // Function to render a single post
    function renderPost(post) {
        const postDiv = document.createElement('div');
        postDiv.id = `post-${post.id}`; // Add an ID for easy lookup
        postDiv.className = 'border border-gray-200 rounded-lg p-4 bg-gray-50 shadow-sm';
        postDiv.innerHTML = `
            <h4 class="font-semibold text-purple-700 text-lg mb-2">${post.title}</h4>
            <p class="text-gray-700 text-base mb-3">${post.content}</p>
            <div class="flex items-center text-xs text-gray-500 mb-4">
                <div class="bg-gray-200 border-2 border-dashed rounded-full w-6 h-6 mr-2 flex items-center justify-center overflow-hidden">
                    <i class="fas fa-user text-gray-400 text-sm"></i>
                </div>
                <span>By ${post.author}</span>
                ${post.city ? `<span class="mx-2">•</span><span>${post.city}</span>` : ''} <!-- Display city if available -->
                <span class="mx-2">•</span>
                <span>${post.timestamp}</span>
            </div>

            <!-- Comments Section -->
            <div class="mt-4 border-t border-gray-200 pt-4">
                <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-comment-dots mr-2 text-blue-500"></i>
                    Comments (<span id="commentCount-${post.id}">${post.comments.length}</span>)
                </h5>
                <div id="commentsList-${post.id}" class="space-y-3 mb-4 max-h-48 overflow-y-auto pr-2">
                    <!-- Comments will be dynamically inserted here -->
                </div>
                <p id="noCommentsMessage-${post.id}" class="text-sm text-gray-600 italic mb-3 ${post.comments.length > 0 ? 'hidden' : ''}">No comments yet. Be the first to reply!</p>

                <!-- Add Comment Input -->
                <div class="flex items-center mt-2">
                    <input type="text" id="commentInput-${post.id}"
                        class="flex-grow px-3 py-2 rounded-l-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                        placeholder="Add a comment..." data-post-id="${post.id}">
                    <button class="add-comment-btn bg-purple-500 text-white p-2 rounded-r-lg hover:bg-purple-600 transition-colors shadow-sm" data-post-id="${post.id}">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        `;
        // Render existing comments for the post
        const commentsList = postDiv.querySelector(`#commentsList-${post.id}`);
        post.comments.forEach(comment => {
            commentsList.appendChild(renderComment(comment));
        });

        return postDiv;
    }

    // Function to render a single comment
    function renderComment(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.id = `comment-${comment.id}`;
        commentDiv.className = 'bg-white border border-gray-100 rounded-lg p-3 shadow-xs';
        commentDiv.innerHTML = `
            <p class="text-gray-700 text-sm mb-1">${comment.text}</p>
            <div class="flex items-center text-xs text-gray-500">
                <div class="bg-gray-200 border-2 border-dashed rounded-full w-5 h-5 mr-1 flex items-center justify-center overflow-hidden">
                    <i class="fas fa-reply text-gray-400 text-xs"></i>
                </div>
                <span>By ${comment.author}</span>
                <span class="mx-1">•</span>
                <span>${comment.timestamp}</span>
            </div>
        `;
        return commentDiv;
    }

    // Function to update the entire posts display
    function updatePostsDisplay() {
        postsContainer.innerHTML = ''; // Clear existing posts

        if (posts.length === 0) {
            noPostsMessage.classList.remove('hidden');
            postsContainer.appendChild(noPostsMessage);
        } else {
            noPostsMessage.classList.add('hidden');
            // Add posts in reverse order to show newest at top
            posts.slice().reverse().forEach(post => {
                postsContainer.appendChild(renderPost(post));
            });
        }
        addCommentEventListeners(); // Re-attach listeners after re-rendering
    }

    // Function to show the new post modal
    function showNewPostModal() {
        newPostModal.classList.remove('hidden');
        setTimeout(() => {
            newPostModalContent.classList.remove('opacity-0', 'scale-95');
            newPostModalContent.classList.add('opacity-100', 'scale-100');
        }, 10); // Small delay for transition
        postTitleInput.value = '';
        postCityInput.value = ''; // Clear city input
        postContentTextarea.value = '';
        postTitleInput.focus();
    }

    // Event handler for adding a new post
    function handleAddPost() {
        const title = postTitleInput.value.trim();
        const city = postCityInput.value.trim(); // Get city value
        const content = postContentTextarea.value.trim();

        if (title === '' || content === '' || city === '') { // Require city now
            showAlert('Please fill in title, content, and city/town for your post.');
            return;
        }

        const newPost = {
            id: generateUniqueId(),
            title: title,
            content: content,
            author: accountStatusText.textContent === 'Guest' ? 'Anonymous User' : accountStatusText.textContent, // Use username if logged in
            city: city, // Add city to the post object
            timestamp: formatTimestamp(new Date()),
            comments: [],
        };

        posts.push(newPost); // Add new post to the array
        updatePostsDisplay(); // Re-render all posts
        hideNewPostModal();
    }

    // Event handler for adding a comment
    function handleAddComment(postId, commentText) {
        if (commentText === '') {
            showAlert('Please enter your comment.');
            return;
        }

        const newComment = {
            id: generateUniqueId(),
            author: accountStatusText.textContent === 'Guest' ? 'Community Member' : accountStatusText.textContent, // Use username if logged in
            text: commentText,
            timestamp: formatTimestamp(new Date()),
        };

        const postIndex = posts.findIndex(p => p.id === postId);
        if (postIndex !== -1) {
            posts[postIndex].comments.push(newComment);

            // Update the specific post's comments section without re-rendering everything
            const commentsListElement = document.getElementById(`commentsList-${postId}`);
            const noCommentsMessageElement = document.getElementById(`noCommentsMessage-${postId}`);
            const commentCountElement = document.getElementById(`commentCount-${postId}`);

            if (commentsListElement) {
                commentsListElement.appendChild(renderComment(newComment));
                commentsListElement.scrollTop = commentsListElement.scrollHeight; // Scroll to bottom
            }
            if (noCommentsMessageElement) {
                noCommentsMessageElement.classList.add('hidden');
            }
            if (commentCountElement) {
                commentCountElement.textContent = posts[postIndex].comments.length;
            }
        }

        // Clear the specific comment input after adding
        const commentInput = document.getElementById(`commentInput-${postId}`);
        if (commentInput) {
            commentInput.value = '';
        }
    }

    // Function to add event listeners to all comment buttons and inputs
    function addCommentEventListeners() {
        document.querySelectorAll('.add-comment-btn').forEach(button => {
            // Remove existing listener to prevent duplicates
            button.removeEventListener('click', handleCommentButtonClick);
            button.addEventListener('click', handleCommentButtonClick);
        });

        document.querySelectorAll('input[id^="commentInput-"]').forEach(input => {
            // Remove existing listener to prevent duplicates
            input.removeEventListener('keypress', handleCommentInputKeyPress);
            input.addEventListener('keypress', handleCommentInputKeyPress);
        });
    }

    // Event handler for comment button click
    function handleCommentButtonClick(event) {
        const postId = event.currentTarget.dataset.postId;
        const commentInput = document.getElementById(`commentInput-${postId}`);
        if (commentInput) {
            handleAddComment(postId, commentInput.value);
        }
    }

    // Event handler for comment input keypress (Enter key)
    function handleCommentInputKeyPress(event) {
        if (event.key === 'Enter') {
            const postId = event.currentTarget.dataset.postId;
            const commentInput = event.currentTarget;
            handleAddComment(postId, commentInput.value);
        }
    }

    // Initial setup and event listeners for Community Forum
    // This will run when the main DoxaCare AI DOMContentLoaded fires
    document.addEventListener('DOMContentLoaded', () => { // Corrected: ensure this wraps all main JS
        updatePostsDisplay(); // Render initial state (no posts)

        newPostBtn.addEventListener('click', showNewPostModal);
        startNewDiscussionBtn.addEventListener('click', showNewPostModal); // Button inside "no posts" message
        closeNewPostModalBtn.addEventListener('click', hideNewPostModal);
        cancelPostBtn.addEventListener('click', hideNewPostModal);
        submitPostBtn.addEventListener('click', handleAddPost);

        // Close modal if clicking outside the content
        newPostModal.addEventListener('click', (event) => {
            if (event.target === newPostModal) {
                hideNewPostModal();
            }
        });
        
        // Emergency modal event listeners
        const emergencyBtn = document.getElementById('emergencyBtn');
        const emergencyModal = document.getElementById('emergencyModal');
        const closeEmergencyModal = document.getElementById('closeEmergencyModal');
        const callEmergencyBtn = document.getElementById('callEmergencyBtn');

        if (emergencyBtn) {
            emergencyBtn.addEventListener('click', () => {
                emergencyModal.classList.remove('hidden');
            });
        }

        if (closeEmergencyModal) {
            closeEmergencyModal.addEventListener('click', () => {
                emergencyModal.classList.add('hidden');
            });
        }

        if (callEmergencyBtn) {
            callEmergencyBtn.addEventListener('click', () => {
                // In a real application, this would initiate a phone call
                // For now, we'll just close the modal and could add a console log
                console.log("Initiating emergency call...");
                emergencyModal.classList.add('hidden');
            });
        }

        // Close emergency modal if clicking outside the content
        if (emergencyModal) {
            emergencyModal.addEventListener('click', (event) => {
                if (event.target === emergencyModal) {
                    emergencyModal.classList.add('hidden');
                }
            });
        }
    });
    // END Community Forum JS
  </script>
</body>
</html>

